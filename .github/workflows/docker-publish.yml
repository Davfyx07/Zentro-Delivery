name: Build and publish backend Docker image

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v4
        with:
          # Use repository root as build context so Dockerfile can reference files
          # using paths like backend/... (matches local build)
          context: .
          file: ./backend/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/zentro-backend:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/zentro-backend:${{ github.sha }}

      - name: Set pushed image tag output
        id: image_info
        run: |
          echo "IMAGE_NAME=${{ secrets.DOCKERHUB_USERNAME }}/zentro-backend" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG=${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Trigger Koyeb deploy (optional)
        env:
          KOYEB_TOKEN: ${{ secrets.KOYEB_API_TOKEN }}
          KOYEB_SERVICE_ID: ${{ secrets.KOYEB_SERVICE_ID }}
          IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/zentro-backend
          IMAGE_TAG: ${{ github.sha }}
        run: |
          if [ -z "${KOYEB_TOKEN}" ] || [ -z "${KOYEB_SERVICE_ID}" ]; then
            echo "KOYEB_API_TOKEN or KOYEB_SERVICE_ID not set — skipping Koyeb deploy"
            exit 0
          fi
          echo "Triggering Koyeb deploy for ${IMAGE_NAME}:${IMAGE_TAG} to service ${KOYEB_SERVICE_ID}"
          curl -s -X POST "https://api.koyeb.com/v1/services/${KOYEB_SERVICE_ID}/deployments" \
            -H "Authorization: Bearer ${KOYEB_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"image":"'"${IMAGE_NAME}:${IMAGE_TAG}"'"}' \
          || true

      - name: Trigger Render Deploy Hook (optional)
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          if [ -z "${RENDER_DEPLOY_HOOK}" ]; then
            echo "RENDER_DEPLOY_HOOK not set — skipping Render deploy"
            exit 0
          fi
          echo "Triggering Render deploy via webhook"
          # Show HTTP response code for easier debugging
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "${RENDER_DEPLOY_HOOK}" ) || true
          echo "Render webhook responded with HTTP status: ${HTTP_CODE}"
